import streamlit as st
import pandas as pd
from datetime import datetime
import json
import os

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="ë©”ëª¨ ì•±", layout="wide")

# CSSë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¸ë ¨ëœ ë””ìì¸ ì ìš©
st.markdown(
    """
    <style>
    .stApp {
        background-color: #ffffff;
    }
    .main-header {
        font-family: 'Helvetica Neue', sans-serif;
        color: #1E88E5;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
        margin-bottom: 30px;
    }
    .memo-container {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        border-left: 5px solid #1E88E5;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
    }
    .memo-container:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .memo-title {
        font-weight: bold;
        font-size: 18px;
        color: #333;
    }
    .memo-date {
        font-size: 12px;
        color: #666;
        margin-bottom: 10px;
    }
    .memo-content {
        color: #444;
        line-height: 1.6;
    }
    .sidebar-header {
        color: #1E88E5;
        font-weight: bold;
        margin-bottom: 20px;
    }
    .stButton>button {
        background-color: #1E88E5;
        color: white;
        border-radius: 5px;
        border: none;
        padding: 5px 15px;
        font-weight: bold;
    }
    .stButton>button:hover {
        background-color: #1976D2;
    }
    .delete-btn>button {
        background-color: #ff5252;
    }
    .delete-btn>button:hover {
        background-color: #e53935;
    }
    .search-box {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 20px;
        background-color: #f8f9fa;
    }
    </style>
    """,
    unsafe_allow_html=True
)

# ì•± ì œëª©
st.markdown("<h1 class='main-header'>ğŸ“ ì„¸ë ¨ëœ ë©”ëª¨ ì•±</h1>", unsafe_allow_html=True)

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'memos' not in st.session_state:
    st.session_state.memos = []

# íŒŒì¼ì—ì„œ ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸° (ì„ íƒì‚¬í•­)
def load_memos():
    try:
        if os.path.exists("memos.json"):
            with open("memos.json", "r") as f:
                return json.load(f)
    except Exception as e:
        st.error(f"ë©”ëª¨ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
    return []

# íŒŒì¼ì— ë©”ëª¨ ì €ì¥í•˜ê¸° (ì„ íƒì‚¬í•­)
def save_memos(memos):
    try:
        with open("memos.json", "w") as f:
            json.dump(memos, f)
    except Exception as e:
        st.error(f"ë©”ëª¨ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

# ì•± ì‹œì‘ ì‹œ ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°
if len(st.session_state.memos) == 0:
    st.session_state.memos = load_memos()

# ì‚¬ì´ë“œë°” - ë©”ëª¨ ì‘ì„±
with st.sidebar:
    st.markdown("<h2 class='sidebar-header'>âœï¸ ìƒˆ ë©”ëª¨ ì‘ì„±</h2>", unsafe_allow_html=True)
    
    memo_title = st.text_input("ì œëª©", placeholder="ë©”ëª¨ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”")
    memo_content = st.text_area("ë‚´ìš©", height=200, placeholder="ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”")
    
    col1, col2 = st.columns([1, 1])
    with col1:
        if st.button("ğŸ’¾ ì €ì¥", key="save_memo"):
            if memo_title and memo_content:
                # ìƒˆ ë©”ëª¨ ìƒì„±
                new_memo = {
                    "id": datetime.now().timestamp(),  # ê³ ìœ  ID ìƒì„±
                    "title": memo_title,
                    "content": memo_content,
                    "date": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                }
                
                # ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                st.session_state.memos.append(new_memo)
                save_memos(st.session_state.memos)  # íŒŒì¼ì— ì €ì¥ (ì„ íƒì‚¬í•­)
                
                st.success("ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!")
                # ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                st.rerun()  # experimental_rerun() ëŒ€ì‹  rerun() ì‚¬ìš©
            else:
                st.warning("ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    
    st.markdown("---")
    st.markdown("### ğŸ“Š í†µê³„")
    st.markdown(f"ğŸ“ **ì´ ë©”ëª¨ ìˆ˜**: {len(st.session_state.memos)}ê°œ")
    
    if st.session_state.memos:
        last_memo_date = max([memo['date'] for memo in st.session_state.memos])
        st.markdown(f"ğŸ•’ **ë§ˆì§€ë§‰ ì‘ì„±**: {last_memo_date}")

# ë©”ì¸ í™”ë©´ - ë©”ëª¨ ëª©ë¡ í‘œì‹œ
col1, col2 = st.columns([3, 1])
with col1:
    st.markdown("### ğŸ“‹ ë©”ëª¨ ëª©ë¡")
with col2:
    sort_option = st.selectbox(
        "ì •ë ¬ ë°©ì‹",
        ["ìµœì‹ ìˆœ", "ì˜¤ë˜ëœìˆœ", "ì œëª©ìˆœ"],
        index=0
    )

# ê²€ìƒ‰ ê¸°ëŠ¥
st.markdown("<div class='search-box'>", unsafe_allow_html=True)
search_term = st.text_input("ğŸ” ë©”ëª¨ ê²€ìƒ‰", "", placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”")
st.markdown("</div>", unsafe_allow_html=True)

# ë©”ëª¨ê°€ ì—†ëŠ” ê²½ìš°
if not st.session_state.memos:
    st.info("ì €ì¥ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤. ì™¼ìª½ ì‚¬ì´ë“œë°”ì—ì„œ ìƒˆ ë©”ëª¨ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!")
else:
    # ë©”ëª¨ í•„í„°ë§
    filtered_memos = st.session_state.memos
    if search_term:
        filtered_memos = [memo for memo in st.session_state.memos 
                         if search_term.lower() in memo['title'].lower() 
                         or search_term.lower() in memo['content'].lower()]
    
    # ë©”ëª¨ ì •ë ¬
    if sort_option == "ìµœì‹ ìˆœ":
        filtered_memos = sorted(filtered_memos, key=lambda x: x['date'], reverse=True)
    elif sort_option == "ì˜¤ë˜ëœìˆœ":
        filtered_memos = sorted(filtered_memos, key=lambda x: x['date'])
    else:  # ì œëª©ìˆœ
        filtered_memos = sorted(filtered_memos, key=lambda x: x['title'])
    
    # ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
    if search_term and filtered_memos:
        st.success(f"'{search_term}'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼: {len(filtered_memos)}ê°œì˜ ë©”ëª¨ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.")
    elif search_term and not filtered_memos:
        st.warning(f"'{search_term}'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
    
    # ë©”ëª¨ í‘œì‹œ
    for memo in filtered_memos:
        col1, col2 = st.columns([5, 1])
        
        with col1:
            st.markdown(f"""
            <div class="memo-container">
                <div class="memo-title">{memo['title']}</div>
                <div class="memo-date">ğŸ“… {memo['date']}</div>
                <hr>
                <div class="memo-content">{memo['content'].replace('\n', '<br>')}</div>
            </div>
            """, unsafe_allow_html=True)
        
        with col2:
            st.markdown("<div class='delete-btn'>", unsafe_allow_html=True)
            if st.button("ğŸ—‘ï¸ ì‚­ì œ", key=f"delete_{memo['id']}"):
                st.session_state.memos.remove(memo)
                save_memos(st.session_state.memos)  # íŒŒì¼ì— ì €ì¥ (ì„ íƒì‚¬í•­)
                st.success("ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
                st.rerun()  # experimental_rerun() ëŒ€ì‹  rerun() ì‚¬ìš©
            st.markdown("</div>", unsafe_allow_html=True)

# ëª¨ë“  ë©”ëª¨ ì‚­ì œ ê¸°ëŠ¥
if st.session_state.memos:
    st.markdown("---")
    col1, col2 = st.columns([4, 1])
    with col2:
        st.markdown("<div class='delete-btn'>", unsafe_allow_html=True)
        if st.button("ğŸ—‘ï¸ ëª¨ë“  ë©”ëª¨ ì‚­ì œ"):
            st.session_state.memos = []
            save_memos([])  # íŒŒì¼ì— ì €ì¥ (ì„ íƒì‚¬í•­)
            st.success("ëª¨ë“  ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
            st.rerun()  # experimental_rerun() ëŒ€ì‹  rerun() ì‚¬ìš©
        st.markdown("</div>", unsafe_allow_html=True)
